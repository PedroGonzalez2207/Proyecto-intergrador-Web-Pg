<header class="main-header">
  <div class="header-content">
    <span class="brand">Explora portafolios y agenda asesorías</span>
  </div>
</header>

<main class="page-main">
  <div class="layout-usuarios">
    <div class="col-left">
      <aside class="perfil-card">
        <ng-container *ngIf="auth.user$ | async as u; else sinUsuario">
          <div class="perfil-info">
            <div class="avatar">
              <div class="initials">
                {{ ((u.displayName || u.email || '?') + '') | slice:0:1 | uppercase }}
              </div>
            </div>

            <h3>{{ u.displayName || 'Usuario' }}</h3>
            <p class="rol">Usuario externo</p>

            <div class="datos">
              <p>{{ u.email }}</p>
            </div>

            <div class="logout-wrapper">
              <button class="btn-logout" (click)="logout()">Cerrar sesión</button>
            </div>
          </div>
        </ng-container>

        <ng-template #sinUsuario>
          <div class="perfil-info empty">
            <p class="rol">Inicia sesión para ver tu perfil y solicitar asesorías.</p>
          </div>
        </ng-template>
      </aside>

      <section class="mis-asesorias-card" *ngIf="misAsesorias.length">
        <h2>
          Mis asesorías
          <span *ngIf="totalAsesoriasRespondidas">
            · Tienes {{ totalAsesoriasRespondidas }} asesoría(s) respondida(s)
          </span>
        </h2>

        <div class="mis-asesorias-list">
          <article class="asesoria-item" *ngFor="let a of misAsesorias">
            <div class="info">
              <h3>{{ a.programadorNombre || 'Programador' }}</h3>

              <p class="fecha">
                {{ (a.fecha && a.hora) ? (a.fecha + ' · ' + a.hora) : (a.fecha || a.hora || '—') }}
              </p>

              <p *ngIf="a.comentario" class="comentario">{{ a.comentario }}</p>
            </div>

            <div class="estado">
              <span
                class="badge-estado"
                [ngClass]="{
                  pendiente: a.estado === 'Pendiente',
                  aprobada: a.estado === 'Aprobada',
                  rechazada: a.estado === 'Rechazada'
                }"
              >
                {{ a.estado }}
              </span>

              <p class="mensaje-programador" *ngIf="a.mensajeProgramador">
                {{ a.mensajeProgramador }}
              </p>
            </div>
          </article>
        </div>
      </section>
    </div>

    <section class="main-card">
      <div class="card-header-usuario">
        <div>
          <h1>Programadores disponibles</h1>
          <p class="subtitle">
            Revisa sus proyectos y selecciona uno para agendar una asesoría.
          </p>
        </div>
      </div>

      <div class="separator"></div>

      <ng-container *ngIf="programadores.length; else sinProgramadores">
        <div class="programadores-list">
          <article class="programador-card" *ngFor="let prog of programadores">
            <header class="prog-header">
              <div>
                <h2>{{ prog.nombre }}</h2>

                <p class="prog-meta" *ngIf="prog.especialidades || prog.bio">
                  <span *ngIf="prog.especialidades">
                    <strong>Especialidades:</strong> {{ prog.especialidades }}
                  </span>
                  <span *ngIf="prog.bio">
                    <strong>Bio:</strong> {{ prog.bio }}
                  </span>
                </p>
              </div>
            </header>

            <div class="portafolios-group" *ngIf="prog.portafolios.length; else sinPortafolios">
              <div class="portafolio-item" *ngFor="let p of prog.portafolios">
                <div class="portafolio-info">
                  <h3>{{ p.titulo }}</h3>
                  <p class="small" *ngIf="p.tecnologias">
                    <strong>Tecnologías:</strong> {{ p.tecnologias }}
                  </p>
                  <p class="small" *ngIf="p.resumen">{{ p.resumen }}</p>

                  <div class="links" *ngIf="p.repoUrl || p.demoUrl">
                    <a *ngIf="p.repoUrl" [href]="p.repoUrl" target="_blank" rel="noopener noreferrer">Repo</a>
                    <a *ngIf="p.demoUrl" [href]="p.demoUrl" target="_blank" rel="noopener noreferrer">Demo</a>
                  </div>
                </div>

                <div class="acciones-programador">
                  <button type="button" class="btn-small" (click)="verDetalle(p)">Ver detalle</button>
                  <button type="button" class="btn-small primary" (click)="seleccionarPortafolio(p)">
                    Ver horarios / Agendar
                  </button>
                </div>
              </div>
            </div>

            <ng-template #sinPortafolios>
              <p class="empty small">Este programador aún no tiene proyectos registrados.</p>
              <div class="acciones-programador">
                <button type="button" class="btn-small primary" (click)="agendarGenerico(prog)">
                  Ver horarios / Agendar asesoría
                </button>
              </div>
            </ng-template>
          </article>
        </div>
      </ng-container>

      <ng-template #sinProgramadores>
        <div class="empty-state">Todavía no hay programadores disponibles.</div>
      </ng-template>
    </section>
  </div>

  <div class="modal-backdrop" *ngIf="mostrarModalAgendar"></div>

  <div class="modal modal-agendar" *ngIf="mostrarModalAgendar && seleccionado">
    <div class="modal-content">
      <h2>Agendar asesoría</h2>
      <p class="modal-subtitle">{{ seleccionado.programadorNombre }}</p>

      <form (ngSubmit)="enviarSolicitud()" class="form">
        <div class="field">
          <label>Fecha</label>
          <input
            type="date"
            [(ngModel)]="fecha"
            name="fecha"
            (ngModelChange)="onFechaChange()"
            required
          />
        </div>

        <div class="field">
          <label>Hora disponible</label>
          <select [(ngModel)]="hora" name="hora" required>
            <option value="" disabled [selected]="!hora">Selecciona una hora</option>
            <option *ngFor="let h of horasDisponibles" [value]="h.value">
              {{ h.label }}
            </option>
          </select>
        </div>

        <div class="field">
          <label>Comentario (opcional)</label>
          <textarea
            [(ngModel)]="comentario"
            name="comentario"
            rows="3"
            placeholder="Describe brevemente el motivo de la asesoría"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-small" (click)="cerrarModalAgendar()">Cancelar</button>
          <button type="submit" class="btn-primary">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="mostrarModalDetalle"></div>
  <div class="modal modal-detalle" *ngIf="mostrarModalDetalle && detalleSeleccionado">
    <div class="modal-content">
      <h2>{{ detalleSeleccionado.titulo }}</h2>
      <p class="modal-subtitle">{{ detalleSeleccionado.programadorNombre }}</p>

      <p *ngIf="detalleSeleccionado.tecnologias">
        <strong>Tecnologías:</strong> {{ detalleSeleccionado.tecnologias }}
      </p>

      <p *ngIf="detalleSeleccionado.resumen">{{ detalleSeleccionado.resumen }}</p>

      <div class="links" *ngIf="detalleSeleccionado.repoUrl || detalleSeleccionado.demoUrl">
        <a *ngIf="detalleSeleccionado.repoUrl" [href]="detalleSeleccionado.repoUrl" target="_blank" rel="noopener noreferrer">Repo</a>
        <a *ngIf="detalleSeleccionado.demoUrl" [href]="detalleSeleccionado.demoUrl" target="_blank" rel="noopener noreferrer">Demo</a>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-small" (click)="cerrarModalDetalle()">Cerrar</button>
      </div>
    </div>
  </div>
</main>

<footer class="main-footer">
  <div class="footer-content">
    <span>© 2025 Code Stage - UPS</span>
  </div>
</footer>
